<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuenta atrÃ¡s</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    header { padding:16px 16px 10px; }
    h1 { font-size:18px; margin:0 0 6px; }
    .sub { opacity:.75; font-size:14px; }
    .grid { display:grid; gap:12px; padding: 0 16px 16px; }
    .card { border:1px solid #e6e6e6; border-radius:16px; padding:12px 14px; }
    #map { height: 50vh; border-radius:16px; overflow:hidden; border:1px solid #e6e6e6; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .pill { background:#f4f4f4; border-radius:999px; padding:8px 10px; font-size:13px; }
    progress { width:100%; height:14px; }
    .big { font-size:22px; font-weight:700; }
    .muted { opacity:.7; }
    .reveal { margin-top:10px; padding:10px 12px; border-radius:12px; background:#f7f7ff; border:1px solid #e7e7ff; display:none; }
    .milestones { display:grid; gap:10px; }
    .mcard { border:1px solid #eee; border-radius:14px; padding:10px 12px; }
    .mhead { display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .mtitle { font-weight:700; }
    .mmeta { opacity:.7; font-size:12px; }
    .locked { opacity:.5; }
  </style>
</head>
<body>
  <header>
    <h1>Algo se estÃ¡ preparandoâ€¦</h1>
    <div class="sub">No hagas planes el fin de semana del <b>8 de mayo de 2026</b>.</div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div class="pill" id="originPill">Origen: â€”</div>
        <div class="pill" id="destPill">Destino: ???</div>
      </div>

      <div style="margin-top:10px;">
        <div class="big" id="countdown">â€”</div>
        <div class="muted" id="progressText">â€”</div>
        <progress id="timeProgress" value="0" max="100"></progress>
      </div>

      <div class="reveal" id="revealBox">
        <div class="big" id="revealTitle">ðŸŽ‰ Destino revelado</div>
        <div id="revealMsg"></div>
      </div>
    </div>

    <div class="card">
      <div class="big" style="font-size:16px;">Hitos</div>
      <div class="muted" style="margin:4px 0 10px;">Se desbloquean segÃºn avanzas por la ruta.</div>
      <div class="milestones" id="milestoneList"></div>
    </div>

    <div id="map"></div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const END = new Date("2026-05-08T18:00:00+02:00");
  const START = new Date("2026-02-14T00:00:00+01:00");

  const ORIGIN = { // Sant Andreu de la Barca
    name: "Sant Andreu de la Barca",
    lat: 41.4472,
    lng: 1.97594
  };

  const DEST = { // Jaca (oculto hasta el final)
    name: "Jaca",
    lat: 42.5710112,
    lng: -0.5494531
  };

  // Ruta aproximada por puntos (sin APIs): Sant Andreu -> Lleida -> Fraga -> Huesca -> Ayerbe -> SabiÃ±Ã¡nigo -> Jaca
  const ROUTE = [
    [ORIGIN.lat, ORIGIN.lng],
    [41.6176, 0.6200],     // Lleida
    [41.5220, -0.3500],    // Fraga
    [42.1401, -0.4089],    // Huesca
    [42.2740, -0.6890],    // Ayerbe
    [42.5190, -0.3660],    // SabiÃ±Ã¡nigo
    [DEST.lat, DEST.lng]
  ];

  // Hitos / Pistas (sin decir â€œJacaâ€ hasta el final)
  // pct = % de ruta desbloqueada
  const MILESTONES = [
    { pct: 8,  title:"Pista 1",  hint:"Vas a necesitar algo cÃ³modo: zapatillas para caminar (no de estreno).", icon:"ðŸ‘Ÿ" },
    { pct: 18, title:"Pista 2",  hint:"Mete una capa extra: por la noche refresca mÃ¡s de lo que parece.", icon:"ðŸ§¥" },
    { pct: 30, title:"Pista 3",  hint:"Esto huele a escapada con paisajes. Cargador, mÃºsica y ganas de carretera.", icon:"ðŸš—" },
    { pct: 45, title:"Pista 4",  hint:"Empiezan las â€˜zonas de montaÃ±aâ€™: mejor una mochila pequeÃ±a para paseo.", icon:"ðŸŽ’" },
    { pct: 60, title:"Pista 5",  hint:"Puede haber plan de miradores / paseo largo. Agua y algo para picar.", icon:"ðŸ’§" },
    { pct: 75, title:"Pista 6",  hint:"Pista cultural: sitio con historia, piedra y aire de norte.", icon:"ðŸ°" },
    { pct: 88, title:"Pista 7",  hint:"Ãšltima recomendaciÃ³n: algo de abrigo ligero + chubasquero por si acaso.", icon:"ðŸŒ¦ï¸" },
    { pct: 97, title:"Pista 8",  hint:"EstÃ¡s a nada. No hagas planes. ConfÃ­a.", icon:"ðŸ’›" }
  ];

  const FINAL_MESSAGE = "Fin de semana reservado. Nos vamos a: ";

  // =========================
  // Helpers
  // =========================
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  const toRad = d => d * Math.PI / 180;
  function distKm(a, b) {
    const R = 6371;
    const dLat = toRad(b[0]-a[0]);
    const dLng = toRad(b[1]-a[1]);
    const lat1 = toRad(a[0]);
    const lat2 = toRad(b[0]);
    const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
    return 2*R*Math.asin(Math.sqrt(s));
  }
  function routeTotalKm(points){
    let total = 0;
    for(let i=1;i<points.length;i++) total += distKm(points[i-1], points[i]);
    return total;
  }
  function pointAlongRoute(points, targetKm){
    let traveled = 0;
    for(let i=1;i<points.length;i++){
      const seg = distKm(points[i-1], points[i]);
      if (traveled + seg >= targetKm){
        const t = seg === 0 ? 0 : ((targetKm - traveled) / seg);
        const lat = points[i-1][0] + (points[i][0]-points[i-1][0]) * t;
        const lng = points[i-1][1] + (points[i][1]-points[i-1][1]) * t;
        return { point:[lat,lng], i, t };
      }
      traveled += seg;
    }
    return { point: points[points.length-1], i: points.length-1, t: 1 };
  }
  function sliceRouteToKm(points, km){
    const total = routeTotalKm(points);
    if (km <= 0) return [points[0]];
    if (km >= total) return points.slice();
    const cut = pointAlongRoute(points, km);
    const out = points.slice(0, cut.i);
    out.push(cut.point);
    return out;
  }
  function formatCountdown(ms){
    const sec = Math.floor(ms/1000);
    const s = sec % 60;
    const min = Math.floor(sec/60);
    const m = min % 60;
    const hr = Math.floor(min/60);
    const h = hr % 24;
    const d = Math.floor(hr/24);
    const pad = n => String(n).padStart(2,"0");
    return `${d} dÃ­as ${pad(h)}:${pad(m)}:${pad(s)}`;
  }

  // =========================
  // UI
  // =========================
  const originPill = document.getElementById("originPill");
  const destPill = document.getElementById("destPill");
  const countdownEl = document.getElementById("countdown");
  const progressText = document.getElementById("progressText");
  const timeProgress = document.getElementById("timeProgress");
  const revealBox = document.getElementById("revealBox");
  const revealMsg = document.getElementById("revealMsg");
  const milestoneList = document.getElementById("milestoneList");

  originPill.textContent = `Origen: ${ORIGIN.name}`;

  // =========================
  // Map
  // =========================
  const map = L.map('map', { zoomControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const fullRouteLine = L.polyline(ROUTE, { weight: 5, opacity: 0.25 }).addTo(map);
  const drawnRouteLine = L.polyline([ROUTE[0]], { weight: 6 }).addTo(map);

  const carIcon = L.divIcon({
    className: "",
    html: `<div style="font-size:22px; transform: translate(-8px,-8px);">ðŸš—</div>`,
    iconSize: [24,24], iconAnchor: [12,12]
  });
  const carMarker = L.marker(ROUTE[0], { icon: carIcon }).addTo(map);

  const originMarker = L.marker([ORIGIN.lat, ORIGIN.lng]).addTo(map).bindPopup(`Salida: ${ORIGIN.name}`);

  let destMarker = null;
  const milestoneMarkers = new Map(); // idx -> marker
  map.fitBounds(fullRouteLine.getBounds(), { padding: [20,20] });

  const totalKm = routeTotalKm(ROUTE);

  function renderMilestones(progressPct){
    milestoneList.innerHTML = "";
    MILESTONES.forEach((m, idx) => {
      const unlocked = progressPct >= m.pct;
      const div = document.createElement("div");
      div.className = "mcard" + (unlocked ? "" : " locked");
      div.innerHTML = `
        <div class="mhead">
          <div class="mtitle">${m.icon} ${m.title}</div>
          <div class="mmeta">${m.pct}%</div>
        </div>
        <div style="margin-top:6px;">${unlocked ? m.hint : "Bloqueado ðŸ”’"}</div>
      `;
      milestoneList.appendChild(div);

      // En mapa: marcador donde estarÃ­a el coche justo al llegar a ese %
      if (unlocked && !milestoneMarkers.has(idx)) {
        const kmAt = totalKm * (m.pct / 100);
        const pos = pointAlongRoute(ROUTE, kmAt).point;
        const marker = L.marker(pos).addTo(map).bindPopup(`<b>${m.icon} ${m.title}</b><br/>${m.hint}`);
        milestoneMarkers.set(idx, marker);
      }
    });
  }

  function tick(){
    const now = new Date();
    const totalMs = END - START;
    const elapsedMs = now - START;
    const t = clamp(elapsedMs / totalMs, 0, 1);

    const kmDone = totalKm * t;
    const pct = Math.round(t * 100);

    const remaining = END - now;
    countdownEl.textContent = (remaining > 0)
      ? `Faltan ${formatCountdown(remaining)}`
      : `Es hoy.`;

    timeProgress.value = pct;
    progressText.textContent = `Progreso: ${pct}% Â· ${kmDone.toFixed(1)} km de ${totalKm.toFixed(1)} km`;

    const partial = sliceRouteToKm(ROUTE, kmDone);
    drawnRouteLine.setLatLngs(partial);
    carMarker.setLatLng(partial[partial.length - 1]);

    renderMilestones(pct);

    const revealed = now >= END;
    if (!revealed) {
      destPill.textContent = "Destino: ???";
      revealBox.style.display = "none";
      if (destMarker) { map.removeLayer(destMarker); destMarker = null; }
    } else {
      destPill.textContent = `Destino: ${DEST.name}`;
      revealBox.style.display = "block";
      revealMsg.innerHTML = `${FINAL_MESSAGE} <b>${DEST.name}</b> ðŸ’›`;

      if (!destMarker) {
        destMarker = L.marker([DEST.lat, DEST.lng]).addTo(map).bindPopup(`Destino: ${DEST.name}`).openPopup();
      }
    }
  }

  tick();
  setInterval(tick, 1000);
</script>
</body>
</html>
